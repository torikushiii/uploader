---
import ProgressBar from "./ProgressBar.astro";
import ErrorMessage from "./ErrorMessage.astro";
---

<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="file" id="fileInput" style="display: none;">
    <div id="pasteArea" style="border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer;">
        <p>Drag and drop files here, or paste an image</p>
        <div id="previewContainer"></div>
    </div>
    <ErrorMessage id="fileSizeError" />
    <button type="submit" class="upload-button">Upload</button>
    <ProgressBar />
    <div id="uploadStatus"></div>
    <div id="uploadResult"></div>
</form>

<script>
    import { validateFileSize, previewFile } from "../utils/fileHelpers";

    const pasteArea = document.getElementById("pasteArea") as HTMLDivElement;
    const fileInput = document.getElementById("fileInput") as HTMLInputElement;
    const uploadForm = document.getElementById("uploadForm") as HTMLFormElement;
    const previewContainer = document.getElementById("previewContainer") as HTMLDivElement;
    const progressBar = document.getElementById("progressBar") as HTMLDivElement;
    const progressBarFill = document.getElementById("progressBarFill") as HTMLDivElement;
    const uploadStatus = document.getElementById("uploadStatus") as HTMLDivElement;
    let showPreview = true;

    interface ProgressFetchOptions extends Omit<RequestInit, "body"> {
        onUploadProgress?: (progressEvent: ProgressEvent) => void;
        body?: XMLHttpRequestBodyInit | null;
    }

    async function progressFetch(url: string, options: ProgressFetchOptions): Promise<Response> {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open(options.method || "GET", url);

            for (const key in options.headers) {
                xhr.setRequestHeader(key, options.headers[key]);
            }

            xhr.onload = () => {
                resolve(new Response(xhr.responseText, {
                    status: xhr.status,
                    statusText: xhr.statusText,
                }));
            };

            xhr.onerror = reject;

            if (xhr.upload && options.onUploadProgress) {
                xhr.upload.onprogress = options.onUploadProgress;
            }

            xhr.send(options.body || null);
        })
    }

    function handleDragOver(event: DragEvent) {
        event.preventDefault();
        event.stopPropagation();
        document.body.classList.add("dragging");
    }

    function handleDragLeave(event: DragEvent) {
        event.preventDefault();
        event.stopPropagation();
        document.body.classList.remove("dragging");
    }

    function handleDrop(event: DragEvent) {
        event.preventDefault();
        event.stopPropagation();
        document.body.classList.remove("dragging");
        showPreview = true;
        const files = event.dataTransfer?.files;
        if (files && files.length > 0) {
            handleFile(files[0]);
        }
    }

    document.addEventListener("dragover", handleDragOver);
    document.addEventListener("dragleave", handleDragLeave);
    document.addEventListener("drop", handleDrop);

    pasteArea.addEventListener("click", () => {
        fileInput.click();
    });

    pasteArea.addEventListener("paste", async (event) => {
        event.preventDefault();
        showPreview = false;

        const items = (event.clipboardData || (event as any).originalEvent.clipboardData).items;

        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") !== -1) {
                const blob = items[i].getAsFile();
                handleFile(blob);
            }
        }
    });

    fileInput.addEventListener("change", (event) => {
        const files = (event.target as HTMLInputElement).files;
        if (files && files.length > 0) {
            showPreview = true;
            handleFile(files[0]);
        }
    });

    uploadForm.addEventListener("submit", (event) => {
        event.preventDefault();

        const file = fileInput.files?.[0];
        if (file && validateFileSize(file)) {
            handleFile(file);
        }
    });

    async function handleFile(file: File) {
        if (showPreview) {
            previewFile(file, previewContainer);
        }

        const formData = new FormData();
        formData.append("file", file, file.name);

        uploadStatus.textContent = "Uploading...";
        uploadStatus.classList.add("loading");
        progressBar.style.display = "block";
        progressBarFill.style.width = "0%";

        try {
            const response = await progressFetch("/api/upload", {
                method: "POST",
                body: formData,
                onUploadProgress: (progressEvent) => {
                    if (progressEvent.lengthComputable) {
                        const percentComplete = (progressEvent.loaded / progressEvent.total) * 100;
                        progressBarFill.style.width = percentComplete + "%";
                    }
                },
            });

            if (response.ok) {
                const data = await response.json();

                const storedFiles = localStorage.getItem("uploadedFiles");
                const files = storedFiles ? JSON.parse(storedFiles) : [];
                files.push(data);
                localStorage.setItem("uploadedFiles", JSON.stringify(files));

                window.location.href = data.link;
            } else {
                const errorData = await response.json();
                displayError(errorData.error);
            }
        } catch (error) {
            displayError("An error occurred during the upload.");
        } finally {
            uploadStatus.textContent = "";
            uploadStatus.classList.remove("loading");
            progressBar.style.display = "none";
        }
    }

    function displayError(error: string) {
        const errorDiv = document.getElementById("fileSizeError") as HTMLDivElement;
        errorDiv.textContent = error;
    }
</script>

<style>
    #uploadForm {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
    }

    #pasteArea {
        width: 80%;
        margin-bottom: 0.3rem;
        transition: all 0.3s ease;
    }

    .upload-button {
        width: 75%;
        margin-top: 0.3rem;
        transition: background-color 0.3s ease;
    }

    .upload-button:hover {
        background-color: #0056b3;
    }

    .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top: 2px solid transparent;
        animation: spin 1s linear infinite;
        margin-left: 10px;
        vertical-align: middle;
    }

    body.dragging::after {
        content: "Drop your file here";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        z-index: 9999;
    }
</style>
